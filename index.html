<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Roster Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            padding: 30px;
            text-align: center;
            color: white;
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 2rem; margin-bottom: 5px; }
        .version { font-size: 0.8rem; opacity: 0.8; margin-top: 10px; }
        .content { padding: 30px; }
        .status { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 500; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #cce7ff; color: #004085; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .student-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .student-item:hover { background: #e9ecef; }
        .student-item.checked { background: #d4edda; border-left-color: #28a745; }
        .student-item.additional { border-left-color: #feca57; background: #fff9e6; }
        .student-item input[type="checkbox"] { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .student-name { flex: 1; font-weight: 500; font-size: 1.1rem; }
        .badge { background: #feca57; color: #856404; padding: 4px 12px; border-radius: 5px; font-size: 0.8rem; font-weight: 600; margin-right: 10px; }
        .time-badge { background: #6c757d; color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.8rem; }
        .count-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .count-number { font-size: 3rem; font-weight: bold; display: block; margin: 10px 0; }
        .count-label { font-size: 1.1rem; opacity: 0.9; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .content { padding: 20px; }
            .count-number { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöå Bus Roster Tracker</h1>
            <p>Check off students as they board</p>
            <div class="version">Version 3.1</div>
        </div>
        
        <div class="content">
            <div id="statusMessage" class="status status-info">Select a route to begin</div>

            <div class="section">
                <h3 style="margin-bottom: 15px;">üìç Select Route</h3>
                <select id="routeSelect" onchange="loadRoute()">
                    <option value="">-- Select a Route --</option>
                </select>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="showCreateRoute()">‚ûï Create New Route</button>
                    <button class="btn" onclick="showImportCSV()">üìÅ Import CSV</button>
                    <button class="btn" onclick="exportAllRoutes()" style="background: linear-gradient(135deg, #17a2b8, #138496);">üíæ Export All Routes</button>
                </div>
            </div>

            <div class="section" id="createRouteSection" style="display: none;">
                <h3 style="margin-bottom: 15px;">‚ûï Create New Route</h3>
                <input type="text" id="newRouteName" placeholder="Enter route name (e.g., Morning Route C)">
                <p style="margin-bottom: 10px; color: #6c757d;">Add student names (one per line):</p>
                <textarea id="newRosterInput" placeholder="Emma Johnson&#10;Liam Smith&#10;Olivia Brown"></textarea>
                <button class="btn btn-success" onclick="createNewRoute()">üíæ Create Route</button>
                <button class="btn" onclick="cancelCreateRoute()">Cancel</button>
            </div>

            <div class="section" id="importCSVSection" style="display: none;">
                <h3 style="margin-bottom: 15px;">üìÅ Import Routes from CSV</h3>
                <p style="margin-bottom: 15px; color: #6c757d;">
                    Upload a CSV with columns: <strong>Bus Route, Last Name, First Name, Grade, To Be Left</strong>
                </p>
                <input type="file" id="csvFileInput" accept=".csv">
                <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>CSV Example:</strong>
                    <pre style="margin-top: 10px; font-size: 0.9rem;">Bus Route,Last Name,First Name,Grade,To Be Left
Morning Route A,Johnson,Emma,5,School
Morning Route A,Smith,Liam,4,Daycare</pre>
                </div>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="hasHeaderRow" checked style="width: auto;">
                    <span>First row contains headers</span>
                </label>
                <button class="btn btn-success" onclick="processCSV()">üì§ Upload & Import</button>
                <button class="btn" onclick="cancelImportCSV()">Cancel</button>
            </div>

            <div class="count-box" id="countBox" style="display: none;">
                <div class="count-label">Students on Bus</div>
                <span class="count-number" id="studentCount">0</span>
                <div class="count-label"><span id="totalCount">0</span> Total Students</div>
                <button class="btn" onclick="recordStop()" style="margin-top: 15px; background: linear-gradient(135deg, #feca57, #ff9ff3);">
                    üìç Record Stop Time
                </button>
                <div id="stopTimes" style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;"></div>
            </div>

            <div id="rosterContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>‚úÖ Student Roster</h3>
                    <button class="btn" onclick="toggleImport()" style="font-size: 0.9rem; padding: 8px 16px;">‚úèÔ∏è Edit Roster</button>
                </div>
                <div id="studentList"></div>
                
                <div class="section" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">‚ûï Add Student Not on Roster</h4>
                    <input type="text" id="additionalName" placeholder="Enter student name">
                    <button class="btn btn-success" onclick="addAdditionalStudent()">Add Student</button>
                </div>
            </div>

            <div class="section" id="importSection" style="display: none;">
                <h3 style="margin-bottom: 15px;">üìù Import/Edit Roster</h3>
                <p style="margin-bottom: 10px; color: #6c757d;">Paste student names (one per line):</p>
                <textarea id="rosterInput" placeholder="Emma Johnson&#10;Liam Smith"></textarea>
                <button class="btn btn-success" onclick="saveRoster()">üíæ Save Roster</button>
                <button class="btn" onclick="toggleImport()">Cancel</button>
            </div>

            <div id="exportSection" style="display: none; margin-top: 30px;">
                <div class="section">
                    <h3 style="margin-bottom: 15px;">üì§ Export & Send Report</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="exportToCSV()">üìä Download CSV</button>
                        <button class="btn btn-success" onclick="sendEmail()">üìß Email Report</button>
                        <button class="btn btn-danger" onclick="clearRun()">üóëÔ∏è Clear Run</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = "jamesbryson@northeastacademy.org";
        let rosters = JSON.parse(localStorage.getItem('busRosters') || JSON.stringify({
            "Morning Route A": [
                {name: "Emma Johnson", grade: "5", toBeLeft: "School"},
                {name: "Liam Smith", grade: "4", toBeLeft: "Daycare"}
            ]
        }));
        let currentRoute = '';
        let boardedStudents = {};
        let arrivalTimes = []; // Changed to array for multiple stops

        document.addEventListener('DOMContentLoaded', function() {
            loadRouteOptions();
            updateStatus('Select a route to begin tracking', 'info');
        });

        function loadRouteOptions() {
            const select = document.getElementById('routeSelect');
            select.innerHTML = '<option value="">-- Select a Route --</option>';
            Object.keys(rosters).forEach(routeName => {
                const option = document.createElement('option');
                option.value = routeName;
                option.textContent = routeName;
                select.appendChild(option);
            });
        }

        function loadRoute() {
            const routeName = document.getElementById('routeSelect').value;
            if (!routeName) {
                document.getElementById('rosterContainer').style.display = 'none';
                document.getElementById('countBox').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
                return;
            }
            currentRoute = routeName;
            boardedStudents = {};
            arrivalTimes = [];
            document.getElementById('stopTimes').innerHTML = '';
            document.getElementById('rosterContainer').style.display = 'block';
            document.getElementById('countBox').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            displayRoster();
            updateStatus(`‚úÖ Loaded ${routeName}`, 'success');
        }

        function recordStop() {
            const stopNumber = arrivalTimes.length + 1;
            const currentTime = new Date().toLocaleString();
            arrivalTimes.push({
                stop: stopNumber,
                time: currentTime
            });
            
            displayStopTimes();
            updateStatus(`‚úÖ Stop ${stopNumber} recorded at ${currentTime}`, 'success');
        }

        function displayStopTimes() {
            const container = document.getElementById('stopTimes');
            if (arrivalTimes.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div style="text-align: left; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 10px;">';
            arrivalTimes.forEach(stop => {
                html += `<div style="margin: 5px 0;">üìç Stop ${stop.stop}: ${stop.time}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayRoster() {
            const container = document.getElementById('studentList');
            container.innerHTML = '';
            const roster = rosters[currentRoute] || [];
            
            roster.forEach(student => {
                const studentName = typeof student === 'string' ? student : student.name;
                const grade = student.grade || '';
                const toBeLeft = student.toBeLeft || '';
                const displayName = grade ? `${studentName} (Grade ${grade})` : studentName;
                const isBoarded = boardedStudents.hasOwnProperty(studentName);
                
                const div = document.createElement('div');
                div.className = 'student-item' + (isBoarded ? ' checked' : '');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isBoarded;
                checkbox.onchange = () => toggleStudent(studentName, toBeLeft);
                
                const label = document.createElement('span');
                label.className = 'student-name';
                label.textContent = displayName + (toBeLeft ? ` ‚Üí ${toBeLeft}` : '');
                label.onclick = () => { checkbox.checked = !checkbox.checked; toggleStudent(studentName, toBeLeft); };
                
                div.appendChild(checkbox);
                div.appendChild(label);
                
                if (isBoarded) {
                    const timeBadge = document.createElement('span');
                    timeBadge.className = 'time-badge';
                    timeBadge.textContent = boardedStudents[studentName].timestamp;
                    div.appendChild(timeBadge);
                }
                container.appendChild(div);
            });

            Object.keys(boardedStudents).forEach(studentName => {
                const isInRoster = roster.some(s => (typeof s === 'string' ? s : s.name) === studentName);
                if (!isInRoster) {
                    const div = document.createElement('div');
                    div.className = 'student-item additional checked';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = true;
                    checkbox.onchange = () => toggleStudent(studentName, boardedStudents[studentName].toBeLeft);
                    
                    const badge = document.createElement('span');
                    badge.className = 'badge';
                    badge.textContent = 'ADDED';
                    
                    const label = document.createElement('span');
                    label.className = 'student-name';
                    const toBeLeft = boardedStudents[studentName].toBeLeft || '';
                    label.textContent = studentName + (toBeLeft ? ` ‚Üí ${toBeLeft}` : '');
                    
                    const timeBadge = document.createElement('span');
                    timeBadge.className = 'time-badge';
                    timeBadge.textContent = boardedStudents[studentName].timestamp;
                    
                    div.appendChild(checkbox);
                    div.appendChild(badge);
                    div.appendChild(label);
                    div.appendChild(timeBadge);
                    container.appendChild(div);
                }
            });
            updateCount();
        }

        function toggleStudent(studentName, toBeLeft = '') {
            if (boardedStudents.hasOwnProperty(studentName)) {
                delete boardedStudents[studentName];
            } else {
                boardedStudents[studentName] = {
                    timestamp: new Date().toLocaleTimeString(),
                    toBeLeft: toBeLeft
                };
            }
            displayRoster();
        }

        function addAdditionalStudent() {
            const input = document.getElementById('additionalName');
            const name = input.value.trim();
            if (!name) {
                updateStatus('‚ö†Ô∏è Please enter a student name', 'error');
                return;
            }
            if (boardedStudents.hasOwnProperty(name)) {
                updateStatus('‚ö†Ô∏è Student already on bus', 'error');
                return;
            }
            boardedStudents[name] = { timestamp: new Date().toLocaleTimeString(), toBeLeft: '' };
            const roster = rosters[currentRoute] || [];
            const existsInRoster = roster.some(s => (typeof s === 'string' ? s : s.name) === name);
            if (!existsInRoster) {
                roster.push({name: name, grade: '', toBeLeft: ''});
                rosters[currentRoute] = roster;
                localStorage.setItem('busRosters', JSON.stringify(rosters));
            }
            input.value = '';
            displayRoster();
            updateStatus(`‚úÖ Added ${name} to roster and checked on board`, 'success');
        }

        function updateCount() {
            const boardedCount = Object.keys(boardedStudents).length;
            const roster = rosters[currentRoute] || [];
            document.getElementById('studentCount').textContent = boardedCount;
            document.getElementById('totalCount').textContent = roster.length;
        }

        function showCreateRoute() {
            document.getElementById('createRouteSection').style.display = 'block';
            document.getElementById('newRouteName').value = '';
            document.getElementById('newRosterInput').value = '';
        }

        function cancelCreateRoute() {
            document.getElementById('createRouteSection').style.display = 'none';
        }

        function createNewRoute() {
            const routeName = document.getElementById('newRouteName').value.trim();
            const rosterInput = document.getElementById('newRosterInput').value;
            if (!routeName) {
                updateStatus('‚ö†Ô∏è Please enter a route name', 'error');
                return;
            }
            if (rosters.hasOwnProperty(routeName)) {
                updateStatus('‚ö†Ô∏è Route already exists', 'error');
                return;
            }
            const names = rosterInput.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            if (names.length === 0) {
                updateStatus('‚ö†Ô∏è Please enter at least one student', 'error');
                return;
            }
            rosters[routeName] = names.map(name => ({name: name, grade: '', toBeLeft: ''}));
            localStorage.setItem('busRosters', JSON.stringify(rosters));
            loadRouteOptions();
            document.getElementById('routeSelect').value = routeName;
            document.getElementById('createRouteSection').style.display = 'none';
            currentRoute = routeName;
            boardedStudents = {};
            document.getElementById('rosterContainer').style.display = 'block';
            document.getElementById('countBox').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            displayRoster();
            updateStatus(`‚úÖ Created route "${routeName}" with ${names.length} students`, 'success');
        }

        function showImportCSV() {
            document.getElementById('importCSVSection').style.display = 'block';
            document.getElementById('csvFileInput').value = '';
        }

        function cancelImportCSV() {
            document.getElementById('importCSVSection').style.display = 'none';
        }

        async function processCSV() {
            console.log('processCSV called');
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            console.log('File:', file);
            
            if (!file) {
                updateStatus('‚ö†Ô∏è Please select a CSV file', 'error');
                return;
            }
            
            updateStatus('üìÇ Reading CSV file...', 'info');
            
            try {
                const text = await file.text();
                console.log('File content length:', text.length);
                console.log('First 200 chars:', text.substring(0, 200));
                
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                console.log('Total lines:', lines.length);
                
                if (lines.length === 0) {
                    updateStatus('‚ö†Ô∏è CSV file is empty', 'error');
                    return;
                }
                
                const hasHeader = document.getElementById('hasHeaderRow').checked;
                const startIndex = hasHeader ? 1 : 0;
                console.log('Has header:', hasHeader, 'Start index:', startIndex);
                
                const newRoutes = {};
                let studentCount = 0;
                let errorCount = 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i];
                    console.log(`Processing line ${i}:`, line);
                    
                    // Split by comma, handling quoted values
                    const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                    console.log('Parts:', parts);
                    
                    if (parts.length < 5) {
                        console.log(`Line ${i}: Not enough columns (${parts.length})`);
                        errorCount++;
                        continue;
                    }
                    
                    const busRoute = parts[0];
                    const lastName = parts[1];
                    const firstName = parts[2];
                    const grade = parts[3];
                    const toBeLeft = parts[4];
                    
                    if (!busRoute || !lastName || !firstName) {
                        console.log(`Line ${i}: Missing required data`);
                        errorCount++;
                        continue;
                    }
                    
                    const fullName = `${firstName} ${lastName}`;
                    const studentObj = {name: fullName, grade: grade, toBeLeft: toBeLeft};
                    
                    if (!newRoutes[busRoute]) {
                        newRoutes[busRoute] = [];
                        console.log('Created new route:', busRoute);
                    }
                    
                    const isDuplicate = newRoutes[busRoute].some(s => s.name === fullName);
                    if (!isDuplicate) {
                        newRoutes[busRoute].push(studentObj);
                        studentCount++;
                        console.log(`Added student: ${fullName} to ${busRoute}`);
                    }
                }
                
                console.log('Routes created:', Object.keys(newRoutes));
                console.log('Total students:', studentCount);
                console.log('Errors:', errorCount);
                
                if (Object.keys(newRoutes).length === 0) {
                    updateStatus(`‚ö†Ô∏è No valid routes found. Errors: ${errorCount}`, 'error');
                    return;
                }
                
                // Sort students by name within each route
                Object.keys(newRoutes).forEach(routeName => {
                    newRoutes[routeName].sort((a, b) => a.name.localeCompare(b.name));
                    rosters[routeName] = newRoutes[routeName];
                });
                
                console.log('Saving to localStorage...');
                localStorage.setItem('busRosters', JSON.stringify(rosters));
                console.log('Saved successfully');
                
                loadRouteOptions();
                document.getElementById('importCSVSection').style.display = 'none';
                
                let message = `‚úÖ Imported ${studentCount} students across ${Object.keys(newRoutes).length} routes`;
                if (errorCount > 0) message += ` (${errorCount} errors)`;
                updateStatus(message, 'success');
                
            } catch (error) {
                console.error('CSV import error:', error);
                updateStatus('‚ùå Error: ' + error.message, 'error');
            }
        }

        function toggleImport() {
            const importSection = document.getElementById('importSection');
            if (importSection.style.display !== 'none') {
                importSection.style.display = 'none';
            } else {
                const roster = rosters[currentRoute] || [];
                document.getElementById('rosterInput').value = roster.map(s => typeof s === 'string' ? s : s.name).join('\n');
                importSection.style.display = 'block';
            }
        }

        function saveRoster() {
            const input = document.getElementById('rosterInput').value;
            const names = input.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            if (names.length === 0) {
                updateStatus('‚ö†Ô∏è Please enter at least one student', 'error');
                return;
            }
            rosters[currentRoute] = names.map(name => ({name: name, grade: '', toBeLeft: ''}));
            localStorage.setItem('busRosters', JSON.stringify(rosters));
            document.getElementById('importSection').style.display = 'none';
            displayRoster();
            updateStatus(`‚úÖ Saved roster with ${names.length} students`, 'success');
        }

        function exportAllRoutes() {
            const allRoutes = Object.keys(rosters);
            
            if (allRoutes.length === 0) {
                updateStatus('‚ö†Ô∏è No routes to export', 'error');
                return;
            }
            
            let totalStudents = 0;
            let csv = 'Bus Route,Last Name,First Name,Grade,To Be Left\n';
            
            // Loop through all routes and add students
            allRoutes.forEach(routeName => {
                const roster = rosters[routeName];
                roster.forEach(student => {
                    const studentName = typeof student === 'string' ? student : student.name;
                    const grade = student.grade || '';
                    const toBeLeft = student.toBeLeft || '';
                    
                    // Split name into first and last
                    const nameParts = studentName.split(' ');
                    let firstName = '';
                    let lastName = '';
                    
                    if (nameParts.length === 1) {
                        firstName = nameParts[0];
                        lastName = '';
                    } else if (nameParts.length === 2) {
                        firstName = nameParts[0];
                        lastName = nameParts[1];
                    } else {
                        // More than 2 parts - first word is first name, rest is last name
                        firstName = nameParts[0];
                        lastName = nameParts.slice(1).join(' ');
                    }
                    
                    csv += `"${routeName}","${lastName}","${firstName}","${grade}","${toBeLeft}"\n`;
                    totalStudents++;
                });
            });
            
            // Create and download the file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_bus_routes_${new Date().toISOString().split('T')[0]}.csv`;
            a.style.visibility = 'hidden';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus(`‚úÖ Exported ${totalStudents} students across ${allRoutes.length} routes`, 'success');
        }

        function exportToCSV() {
            if (Object.keys(boardedStudents).length === 0) {
                updateStatus('‚ö†Ô∏è No students to export', 'error');
                return;
            }
            let csv = 'Route,Student Name,Board Time,Destination,Status\n';
            const roster = rosters[currentRoute] || [];
            Object.keys(boardedStudents).forEach(name => {
                const studentData = boardedStudents[name];
                const rosterEntry = roster.find(s => (typeof s === 'string' ? s : s.name) === name);
                const status = rosterEntry ? 'Rostered' : 'Added';
                const destination = studentData.toBeLeft || '';
                csv += `"${currentRoute}","${name}","${studentData.timestamp}","${destination}","${status}"\n`;
            });
            if (arrivalTimes.length > 0) {
                csv += `\n`;
                arrivalTimes.forEach(stop => {
                    csv += `Stop ${stop.stop}:,"${stop.time}"\n`;
                });
            }
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bus_run_${currentRoute.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            updateStatus('‚úÖ CSV downloaded', 'success');
        }

        function sendEmail() {
            if (Object.keys(boardedStudents).length === 0) {
                updateStatus('‚ö†Ô∏è No students to send', 'error');
                return;
            }
            const roster = rosters[currentRoute] || [];
            const boardedCount = Object.keys(boardedStudents).length;
            const subject = `Bus Report: ${currentRoute} - ${new Date().toLocaleDateString()}`;
            let body = `Bus Run Report\n\nRoute: ${currentRoute}\nDate: ${new Date().toLocaleString()}\nStudents Boarded: ${boardedCount}\n`;
            if (arrivalTimes.length > 0) {
                body += `\nStop Times:\n`;
                arrivalTimes.forEach(stop => {
                    body += `  Stop ${stop.stop}: ${stop.time}\n`;
                });
            }
            body += `\nStudent List:\n================\n`;
            Object.keys(boardedStudents).sort().forEach((name, i) => {
                const studentData = boardedStudents[name];
                const rosterEntry = roster.find(s => (typeof s === 'string' ? s : s.name) === name);
                const status = rosterEntry ? '' : ' (ADDED TO ROSTER)';
                const destination = studentData.toBeLeft ? ` ‚Üí ${studentData.toBeLeft}` : '';
                body += `${i + 1}. ${name} - Boarded: ${studentData.timestamp}${destination}${status}\n`;
            });
            const mailtoLink = `mailto:${ADMIN_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            updateStatus('üìß Email opened', 'success');
        }

        function clearRun() {
            if (!confirm('Clear all checked students and stop times for this run?')) return;
            boardedStudents = {};
            arrivalTimes = [];
            displayRoster();
            displayStopTimes();
            updateStatus('üóëÔ∏è Run cleared', 'info');
        }

        function updateStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status status-${type}`;
        }
    </script>
</body>
</html>
